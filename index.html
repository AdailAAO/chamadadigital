<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Di√°rio Mobile Oficial</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
      :root {
        --primary: #2c3e50;
        --success: #27ae60;
        --danger: #e74c3c;
        --light: #f8f9fa;
      }
      body {
        font-family: sans-serif;
        background: #eaedf1;
        margin: 0;
        padding: 10px;
      }
      .container {
        max-width: 600px;
        margin: auto;
        background: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .stats {
        display: flex;
        justify-content: space-around;
        background: var(--light);
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 15px;
        font-weight: bold;
        border: 1px solid #ddd;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        overflow-x: auto;
        padding-bottom: 5px;
      }
      .tab-btn {
        padding: 10px 15px;
        border: none;
        background: #dcdde1;
        border-radius: 8px;
        font-weight: bold;
        white-space: nowrap;
        cursor: pointer;
      }
      .tab-btn.active {
        background: var(--primary);
        color: white;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
        font-size: 16px;
      }
      .presence-check {
        width: 35px;
        height: 35px;
        cursor: pointer;
      }
      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
      }
      .btn {
        padding: 15px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        color: white;
        font-size: 14px;
        text-align: center;
      }
      .btn-sync {
        background: var(--primary);
        grid-column: span 2;
      }
      .btn-pdf {
        background: var(--danger);
        grid-column: span 2;
      }
      .btn-admin {
        background: #8e44ad;
        display: none;
        grid-column: span 2;
      }
      #statusLoader {
        text-align: center;
        color: #8e44ad;
        font-weight: bold;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 style="text-align: center; color: var(--primary)">
        Di√°rio de Classe
      </h2>
      <div id="statusLoader">Iniciando sistema...</div>

      <div class="stats">
        <span>Turma: <span id="nomeTurma">-</span></span>
        <span
          >Presentes: <span id="txtPres">0</span>/<span id="txtTotal"
            >0</span
          ></span
        >
      </div>

      <div class="tabs" id="tabContainer"></div>
      <table>
        <tbody id="corpoTabela"></tbody>
      </table>

      <div class="actions">
        <button class="btn btn-sync" onclick="sincronizarComGoogle()">
          ‚òÅÔ∏è Salvar Chamada na Nuvem
        </button>
        <button class="btn btn-pdf" onclick="exportarPDF()">
          üìÑ Gerar PDF da Chamada
        </button>
        <button
          id="btnImportar"
          class="btn btn-admin"
          onclick="document.getElementById('inputExcel').click()"
        >
          üì• Importar Excel (Admin)
        </button>
        <input
          type="file"
          id="inputExcel"
          accept=".xlsx, .xls"
          style="display: none"
        />
      </div>
    </div>

    <script>
      // Mantenha seu SCRIPT_URL aqui
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzKTF6hKO-E_P6K2bcJv1AvIXa3CLuomXZRClx3LTTqmwFtSAtbvwDfV52lJkJ9MaT0bg/exec";

      let dadosAlunos = JSON.parse(localStorage.getItem("diario_cloud")) || [];
      let turmaAtual = "";

      async function inicializarApp() {
        const loader = document.getElementById("statusLoader");
        try {
          const response = await fetch(SCRIPT_URL);
          const dadosNuvem = await response.json();
          if (dadosNuvem && dadosNuvem.length > 0) {
            dadosAlunos = dadosNuvem.map((a) => ({
              nome: a.Nome,
              turma: a.Turma,
              presente: false,
            }));
            localStorage.setItem("diario_cloud", JSON.stringify(dadosAlunos));

            // CORRE√á√ÉO 1: Seleciona automaticamente a primeira turma
            const turmasDisponiveis = [
              ...new Set(dadosAlunos.map((a) => a.turma)),
            ];
            turmaAtual = turmasDisponiveis[0];
            renderizarTudo();
          }
        } catch (e) {
          if (dadosAlunos.length > 0) {
            turmaAtual = [...new Set(dadosAlunos.map((a) => a.turma))][0];
            renderizarTudo();
          }
        }
        loader.style.display = "none";
      }

      function renderizarTudo() {
        const tabContainer = document.getElementById("tabContainer");
        const corpo = document.getElementById("corpoTabela");
        const turmas = [...new Set(dadosAlunos.map((a) => a.turma))];

        tabContainer.innerHTML = "";
        turmas.forEach((t) => {
          const btn = document.createElement("button");
          btn.className = `tab-btn ${t === turmaAtual ? "active" : ""}`;
          btn.innerText = t;
          btn.onclick = () => {
            turmaAtual = t;
            renderizarTudo();
          };
          tabContainer.appendChild(btn);
        });

        corpo.innerHTML = "";
        const filtrados = dadosAlunos.filter((a) => a.turma === turmaAtual);

        filtrados.forEach((aluno) => {
          const tr = document.createElement("tr");
          // CORRE√á√ÉO 2: Clique em qualquer lugar da linha marca a presen√ßa
          tr.style.cursor = "pointer";
          tr.onclick = (e) => {
            if (e.target.type !== "checkbox") {
              const check = tr.querySelector("input");
              check.checked = !check.checked;
              atualizarStatus(aluno.nome, check.checked);
            }
          };

          tr.innerHTML = `
        <td style="padding: 15px;">${aluno.nome}</td>
        <td align="right" style="padding-right: 20px;">
            <input type="checkbox" class="presence-check" ${aluno.presente ? "checked" : ""} 
            onchange="atualizarStatus('${aluno.nome}', this.checked)">
        </td>`;
          corpo.appendChild(tr);
        });

        document.getElementById("nomeTurma").innerText = turmaAtual;
        document.getElementById("txtTotal").innerText = filtrados.length;
        document.getElementById("txtPres").innerText = filtrados.filter(
          (a) => a.presente,
        ).length;
      }

      function atualizarStatus(nome, status) {
        const idx = dadosAlunos.findIndex((a) => a.nome === nome);
        dadosAlunos[idx].presente = status;
        // N√£o renderiza tudo de novo para n√£o perder o foco, apenas atualiza os n√∫meros
        document.getElementById("txtPres").innerText = dadosAlunos.filter(
          (a) => a.turma === turmaAtual && a.presente,
        ).length;
      }

      // CORRE√á√ÉO 3: Envia apenas a turma atual com identifica√ß√£o
      async function sincronizarComGoogle() {
        if (!turmaAtual) return alert("Selecione uma turma.");

        const dadosParaEnviar = {
          turma: turmaAtual,
          data: new Date().toLocaleDateString(),
          alunos: dadosAlunos.filter((a) => a.turma === turmaAtual),
        };

        document.getElementById("statusLoader").style.display = "block";
        try {
          await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(dadosParaEnviar),
          });
          alert(`Chamada da turma ${turmaAtual} enviada!`);
        } catch (e) {
          alert("Erro ao salvar.");
        }
        document.getElementById("statusLoader").style.display = "none";
      }
    </script>
  </body>
</html>
